<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tele Electric Payment</title>
    <link rel="stylesheet" href="main.css" />
    <script src="js/config.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>Tele Electric Bike</h1>
      <div id="status" class="status locked">Status: Locked</div>
      <div id="spinner"></div>
      <button id="unlockBtn">Unlock Bike</button>
      <div id="timer" class="timer" style="display: none"></div>
      <img id="bikeImage" src="bicycleRiding.gif" alt="Bike Image" />
      <button id="lockBtn" onclick="lockBike()">Lock Bike</button>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const imei = localStorage.getItem("imei");
      const bikeId = localStorage.getItem("bikeId");

      const payBtn = document.getElementById("payBtn");
      const unlockBtn = document.getElementById("unlockBtn");
      const lockBtn = document.getElementById("lockBtn");
      const statusDiv = document.getElementById("status");
      const spinner = document.getElementById("spinner");
      const priceDiv = document.getElementById("price");
      const timeButtons = document.getElementById("timeButtons");
      const timerDiv = document.getElementById("timer");
      const bikeImage = document.getElementById("bikeImage");
      const token = localStorage.getItem("token");
      const paymentToken = localStorage.getItem("payment_token");
      const selectedDuration = localStorage.getItem("selectedDuration");
      let pollingInterval;
      let timerInterval;
      let eventSource;

      const CHECK_STATUS_URL =
        window.APP_CONFIG.BASE_URL + "/api/devices/getBikeStatus";

      let headers = new Headers();
      headers.append("Content-Type", "application/json");
      headers.append("Accept", "application/json");
      headers.append("Authorization", `Bearer ${token}`);

      function pollBikeStatus(expectedStatus) {
        pollingInterval = setInterval(() => {
          fetch(CHECK_STATUS_URL, {
            method: "POST",
            headers: headers,
            body: JSON.stringify({ imei, payment_token: paymentToken }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.bikeStatus == expectedStatus) {
                clearInterval(pollingInterval);
                spinner.style.display = "none";

                if (expectedStatus === "unlocked") {
                  statusDiv.textContent = "Status: Unlocked";
                  statusDiv.classList.remove("locked");
                  statusDiv.classList.add("unlocked");
                  unlockBtn.style.display = "none";
                  lockBtn.style.display = "block";
                  lockBtn.disabled = false;

                  // Hide time buttons and show timer
                  timerDiv.style.display = "block";
                  bikeImage.style.display = "block";

                  startTimer(); // Start the countdown timer
                } else if (expectedStatus === "locked") {
                  statusDiv.textContent = "Status: Locked";
                  statusDiv.classList.remove("unlocked");
                  statusDiv.classList.add("locked");
                  lockBtn.style.display = "none";
                  unlockBtn.style.display = "block";
                  unlockBtn.disabled = false;

                  // Show time buttons and hide timer
                  timerDiv.style.display = "none";
                  bikeImage.style.display = "none";
                  resetTimer(); // Reset the timer when the bike is locked
                }
              }
            })
            .catch((err) => {
              console.error("Error checking status:", err);
              clearInterval(pollingInterval);
              spinner.style.display = "none";
            });
        }, 2000);
      }

      // Unlock button event
      unlockBtn.addEventListener("click", () => {
        unlockBtn.disabled = true;
        spinner.style.display = "block";
        statusDiv.textContent = "Status: Unlocking...";
        fetch(window.APP_CONFIG.BASE_URL + "/api/devices/send-clr0", {
          method: "POST",
          headers: headers,
          body: JSON.stringify({ imei, payment_token: paymentToken }),
        })
          .then((response) => response.json())
          .then(() => {
            pollBikeStatus("unlocked");
          })
          .catch((err) => {
            console.error("Error unlocking bike:", err);
            spinner.style.display = "none";
            statusDiv.textContent = "Error unlocking bike.";
            unlockBtn.disabled = false;
          });
      });

      // Lock button event
      function lockBike() {
        lockBtn.disabled = true;
        spinner.style.display = "block";
        statusDiv.textContent = "Status: Locking...";
        fetch(window.APP_CONFIG.BASE_URL + "/api/devices/send-clr1", {
          method: "POST",
          headers: headers,
          body: JSON.stringify({ imei, payment_token: paymentToken }),
        })
          .then((response) => response.json())
          .then(() => {
            pollBikeStatus("locked");
          })
          .catch((err) => {
            console.error("Error locking bike:", err);
            spinner.style.display = "none";
            statusDiv.textContent = "Error locking bike.";
            lockBtn.disabled = false;
          });
      }

      // Timer countdown
      function startTimer() {
        let remainingTime = selectedDuration * 60 || 60;
        timerInterval = setInterval(() => {
          if (remainingTime <= 0) {
            clearInterval(timerInterval);
            timerDiv.textContent = "Time's up!";
            lockBtn.disabled = true; // Disable lock button when time is up
          } else {
            let minutes = Math.floor(remainingTime / 60);
            let seconds = remainingTime % 60;
            timerDiv.textContent = `Timer: ${minutes}m ${seconds}s`;
            remainingTime--;
          }
        }, 1000);
      }

      // Reset Timer and UI
      function resetTimer() {
        clearInterval(timerInterval);
        timerDiv.style.display = "none";
        bikeImage.style.display = "none";
        <!-- priceDiv.textContent = "Price: 0 Birr"; -->
        unlockBtn.disabled = true;
        selectedDuration = null;
        const buttons = document.querySelectorAll(".radio-buttons button");
        buttons.forEach((button) => {
          button.classList.remove("selected");
        });
      }

      function connectSSE() {
        const statusDiv = document.getElementById("status");
        const eventsDiv = document.getElementById("events");
        const userId = localStorage.getItem("userId");
        if (!userId) {
          console.error("User ID is not defined");
          return;
        }

        // Close any existing connection
        if (eventSource) {
          eventSource.close();
        }

        // Connect to the SSE endpoint with the user's ID
        eventSource = new EventSource(
          `${window.APP_CONFIG.BASE_URL}/api/webhook/events/${userId}`
        );
        console.log("Connecting to server...");
        eventSource.onopen = () => {
          console.log("Connected to server!");
        };

        eventSource.onmessage = (event) => {
          // The above is event data json, let check the trade_status
          if (eventData.trade_status === "Completed") {
            // If trade_status is Completed, then we can get the trans_id and trans_currency
            console.log(eventData.trans_id);
            console.log(eventData.trans_currency);
          }
          const eventData = JSON.parse(event.data);
          const eventElement = document.createElement("div");
          console.log(eventData);
        };

        eventSource.onerror = (error) => {
          console.error("SSE error:", error);
        };
      }
    </script>
  </body>
</html>
